<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon YouTube avec Firebase</title>
    <link rel="stylesheet" href="style.css">
    </head>
<body>
    <nav class="navbar">
        <div class="logo">MyTube <span style="font-size: 12px; color: #aaa;">Secure</span></div>
        
        <div class="user-actions">
            <button id="loginBtn" class="btn" style="background: #4285F4; border: none;">G Se connecter</button>
            
            <div id="userProfile" style="display: none; align-items: center; gap: 10px;">
                <img id="userAvatar" src="" style="width: 32px; height: 32px; border-radius: 50%;">
                <span id="userName">Pseudo</span>
                <button id="logoutBtn" class="btn" style="background: #333;">DÃ©connexion</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <aside id="uploadSection" class="upload-section" style="display: none;">
            <h3>ğŸ¥ Publier sur ma chaÃ®ne</h3>
            <input type="text" id="vidTitle" placeholder="Titre de la vidÃ©o" required>
            <textarea id="vidDesc" placeholder="Description..."></textarea>
            <input type="file" id="videoFile" accept="video/*">
            <button id="uploadBtn" class="btn">ğŸš€ Envoyer la vidÃ©o</button>
            <p id="status"></p>
        </aside>

        <div id="loginMessage" style="padding: 20px; background: #202020; margin-bottom: 20px; display: block;">
            <p>ğŸ‘‹ Connectez-vous avec Google pour crÃ©er votre chaÃ®ne et publier des vidÃ©os !</p>
        </div>

        <main class="feed">
            <h2>VidÃ©os RÃ©centes</h2>
            <div id="videoGallery">Loading...</div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        // Ajout des outils d'authentification
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            // --- REMETS TES INFOS DE L'Ã‰TAPE PRÃ‰CÃ‰DENTE ICI ---
            apiKey: "...",
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app); // Initialisation de l'auth
        const provider = new GoogleAuthProvider(); // Fournisseur Google

        // --- GESTION DE LA CONNEXION ---

        // 1. Clic sur "Se connecter"
        document.getElementById('loginBtn').addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    console.log("ConnectÃ© en tant que : " + result.user.displayName);
                }).catch((error) => {
                    console.error("Erreur de connexion", error);
                });
        });

        // 2. Clic sur "DÃ©connexion"
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("DÃ©connectÃ©");
            });
        });

        // 3. SURVEILLANCE DE L'Ã‰TAT (Le coeur du systÃ¨me)
        // Cette fonction se dÃ©clenche automatiquement dÃ¨s que l'utilisateur se connecte ou se dÃ©connecte
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // L'utilisateur est connectÃ©
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('loginMessage').style.display = 'none';
                
                document.getElementById('userProfile').style.display = 'flex';
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;
                
                // Afficher la zone d'upload
                document.getElementById('uploadSection').style.display = 'block';
            } else {
                // L'utilisateur est dÃ©connectÃ©
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('loginMessage').style.display = 'block';
                
                document.getElementById('userProfile').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'none';
            }
        });

        // --- GESTION DE L'UPLOAD ---
        
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const user = auth.currentUser; // On rÃ©cupÃ¨re l'utilisateur actuel

            if (!user) {
                alert("Vous devez Ãªtre connectÃ© !");
                return;
            }

            const file = document.getElementById('videoFile').files[0];
            const title = document.getElementById('vidTitle').value;
            const desc = document.getElementById('vidDesc').value;
            const statusTxt = document.getElementById('status');

            if (!file || !title) return alert("Manque titre ou fichier");

            statusTxt.textContent = "Upload en cours...";

            try {
                // On range la vidÃ©o dans un dossier au nom de l'utilisateur pour Ãªtre propre
                const storageRef = ref(storage, `videos/${user.uid}/${Date.now()}-${file.name}`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                // On sauvegarde avec les infos AUTOMATIQUES de Google (plus de triche sur le nom de chaÃ®ne !)
                await addDoc(collection(db, "videos"), {
                    title: title,
                    description: desc,
                    videoUrl: downloadURL,
                    createdAt: new Date(),
                    // INFOS DE LA CHAÃNE (Venant de Google)
                    channelName: user.displayName,
                    channelAvatar: user.photoURL,
                    userId: user.uid // ID unique de l'utilisateur
                });

                statusTxt.textContent = "âœ… PubliÃ© !";
                document.getElementById('vidTitle').value = ""; // Vider le champ
                loadVideos();
            } catch (error) {
                console.error(error);
                statusTxt.textContent = "Erreur upload.";
            }
        });

        // --- CHARGEMENT DES VIDÃ‰OS ---
        async function loadVideos() {
            const gallery = document.getElementById('videoGallery');
            gallery.innerHTML = "";
            const q = query(collection(db, "videos"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);

            snapshot.forEach((doc) => {
                const data = doc.data();
                // On ajoute l'avatar de la chaÃ®ne Ã  cÃ´tÃ© du nom
                gallery.innerHTML += `
                    <div class="video-post" style="margin-bottom: 30px; background: #202020; padding: 15px; border-radius: 8px;">
                        <video controls src="${data.videoUrl}" style="width: 100%; border-radius: 4px;"></video>
                        <h3 style="margin: 10px 0 5px;">${data.title}</h3>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <img src="${data.channelAvatar}" style="width: 24px; height: 24px; border-radius: 50%;">
                            <span style="color: #aaa; font-size: 13px;">${data.channelName}</span>
                        </div>
                        <p style="color: #ddd;">${data.description || ''}</p>
                    </div>
                `;
            });
        }

        loadVideos();
    </script>
</body>
</html>
