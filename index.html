<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTube Cloud - Cha√Ænes Personnalis√©es</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <nav class="navbar">
        <div class="logo">MyTube <span style="font-size: 12px; color: #aaa;">S√©curis√©</span></div>
        
        <div class="user-actions">
            <button id="loginBtn" class="btn" style="background: #4285F4; border: none;">G Se connecter</button>
            
            <div id="userProfile" style="display: none; align-items: center; gap: 10px;">
                <img id="userAvatar" src="" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%;">
                <span id="userName">Pseudo</span> 
                <button id="editChannelBtn" class="btn" style="background: #3a3a3a; font-size: 12px; padding: 4px 8px;">Modifier Cha√Æne</button>
                <button id="logoutBtn" class="btn" style="background: #333;">D√©connexion</button>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <aside id="uploadSection" class="upload-section" style="display: none;">
            <h3>üé• Publier sur ma cha√Æne</h3>
            <p id="publish_hint" style="color: #FFC107; display: none;">üîí **Attention :** Vous devez cr√©er un nom de cha√Æne pour pouvoir publier.</p>
            <input type="text" id="vidTitle" placeholder="Titre de la vid√©o" required>
            <textarea id="vidDesc" placeholder="Description..."></textarea>
            <input type="file" id="videoFile" accept="video/*">
            <button id="uploadBtn" class="btn">üöÄ Envoyer la vid√©o</button>
            <p id="status"></p>
        </aside>

        <main class="feed">
            <h2>Vid√©os R√©centes</h2>
            <div id="videoGallery">Chargement des vid√©os...</div>
        </main>
    </div>

    <div id="channelSetupModal" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0, 0, 0, 0.9); z-index: 200; 
        display: none; justify-content: center; align-items: center;">
        
        <div style="background: #282828; padding: 30px; border-radius: 8px; width: 300px; text-align: center;">
            <h3 style="color: white;">Bienvenue sur MyTube !</h3>
            <p style="color: #ccc;">Choisissez le nom de votre cha√Æne (il sera affich√© publiquement) :</p>
            <input type="text" id="customChannelNameInput" placeholder="Ex: Ma Super Cha√Æne" style="width: 90%; padding: 10px; margin-bottom: 15px; border: 1px solid #444; background: #121212; color: white;">
            <button id="saveChannelNameBtn" class="btn" style="background: red; border: none; padding: 10px 20px; cursor: pointer;">Enregistrer</button>
        </div>
    </div>


    <script type="module">
    // Importations des modules Firebase (Firestore et Auth sont toujours n√©cessaires)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, orderBy, query, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIGURATION FIREBASE (√Ä REMPLACER) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDbX82YY7nE1WpkmNnSYzb5kJLKhSEWFME", 
        authDomain: "pamplemouchevideo.firebaseapp.com", 
        projectId: "pamplemouchevideo", 
        storageBucket: "pamplemouchevideo.firebasestorage.app", 
        messagingSenderId: "219220465922",
        appId: "1:219220465922:web:7c95f3cba5c6726e7c8a1b"
    };
    // -------------------------------------------

    // --- CONFIGURATION CLOUDINARY (√Ä REMPLACER) ---
    // ATTENTION : Le preset doit √™tre 'unsigned' (non sign√©) pour l'upload direct depuis le navigateur.
    // Cr√©e un 'Upload preset' dans ta console Cloudinary et choisis "Unsigned".
    const CLOUDINARY_CLOUD_NAME = "dvr8ggobq"; // <--- Ton nom de Cloud Cloudinary
    const CLOUDINARY_UPLOAD_PRESET = "Hellos"; // <--- Ton Preset Unsigned (Ex: 'my_unsigned_preset')
    // ---------------------------------------------
    
    // Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // R√©f√©rences aux √©l√©ments du DOM
    const loginBtn = document.getElementById('loginBtn');
    const userProfile = document.getElementById('userProfile');
    const uploadSection = document.getElementById('uploadSection');
    const modal = document.getElementById('channelSetupModal');
    const publishHint = document.getElementById('publish_hint');
    const editChannelBtn = document.getElementById('editChannelBtn'); 
    
    // --- 1. GESTION AUTHENTIFICATION ET PROFIL ---
    
    loginBtn.addEventListener('click', () => {
        signInWithPopup(auth, provider).catch((error) => console.error("Erreur de connexion", error));
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth);
    });

    editChannelBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists() && userDoc.data().customChannelName) {
            document.getElementById('customChannelNameInput').value = userDoc.data().customChannelName;
        }
        modal.style.display = 'flex';
    });

    document.getElementById('saveChannelNameBtn').addEventListener('click', async () => {
        const user = auth.currentUser;
        const customName = document.getElementById('customChannelNameInput').value.trim();
        if (customName.length < 3) return alert("Le nom de la cha√Æne doit contenir au moins 3 caract√®res.");

        try {
            await setDoc(doc(db, "users", user.uid), {
                customChannelName: customName,
                googleName: user.displayName,
                avatarURL: user.photoURL,
                userId: user.uid
            });

            modal.style.display = 'none';
            document.getElementById('userName').textContent = customName;
            publishHint.style.display = 'none'; 

        } catch (error) {
            console.error("Erreur lors de la sauvegarde du nom de cha√Æne:", error);
            alert("Impossible d'enregistrer le nom de cha√Æne.");
        }
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            loginBtn.style.display = 'none';
            userProfile.style.display = 'flex';
            uploadSection.style.display = 'block';

            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists() && userDoc.data().customChannelName) {
                const profile = userDoc.data();
                document.getElementById('userName').textContent = profile.customChannelName;
                document.getElementById('userAvatar').src = profile.avatarURL;
                publishHint.style.display = 'none'; 
            } else {
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;
                publishHint.style.display = 'block'; 
            }
            modal.style.display = 'none'; 
        } 
        else {
            loginBtn.style.display = 'block';
            userProfile.style.display = 'none';
            uploadSection.style.display = 'none';
            modal.style.display = 'none';
        }
        loadVideos(); // Charger les vid√©os pour tout le monde
    });


    // --- 2. LOGIQUE D'UPLOAD CLOUDINARY ---

    document.getElementById('uploadBtn').addEventListener('click', async () => {
        const user = auth.currentUser;

        if (!user) return alert("Vous devez √™tre connect√© !");

        // V√©rification de la cha√Æne
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists() || !userDoc.data().customChannelName) {
            modal.style.display = 'flex';
            document.getElementById('status').textContent = "Cr√©ez d'abord votre cha√Æne pour publier !";
            return;
        }
        const profile = userDoc.data();
        
        const file = document.getElementById('videoFile').files[0];
        const title = document.getElementById('vidTitle').value;
        const desc = document.getElementById('vidDesc').value;
        const statusTxt = document.getElementById('status');

        if (!file || !title) return alert("Manque titre ou fichier.");

        statusTxt.textContent = "Upload Cloudinary en cours... (Cela peut prendre du temps)";

        try {
            // Cr√©ation de l'objet FormData pour l'envoi HTTP
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            formData.append('folder', user.uid); // Optionnel: Range le fichier dans un dossier par UID
            formData.append('resource_type', 'video'); // Indiquer qu'il s'agit d'une vid√©o

            // Requ√™te POST vers l'API Cloudinary
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Cloudinary API Error: ${response.statusText}`);
            }

            const data = await response.json();
            const videoURL = data.secure_url; // L'URL de lecture s√©curis√©e fournie par Cloudinary

            // Sauvegarde de l'URL Cloudinary dans Firestore
            await addDoc(collection(db, "videos"), {
                title: title,
                description: desc,
                videoUrl: videoURL, // <--- L'URL Cloudinary
                createdAt: new Date(),
                channelName: profile.customChannelName,
                channelAvatar: profile.avatarURL,
                userId: user.uid
            });

            statusTxt.textContent = "‚úÖ Publi√© !";
            document.getElementById('vidTitle').value = "";
            document.getElementById('vidDesc').value = ""; 
            document.getElementById('videoFile').value = null;
            loadVideos();
        } catch (error) {
            console.error(error);
            statusTxt.textContent = "‚ùå Erreur upload : " + error.message;
        }
    });

    // --- 3. GESTION DE LA LECTURE ---

    async function loadVideos() {
        const gallery = document.getElementById('videoGallery');
        gallery.innerHTML = "";
        const q = query(collection(db, "videos"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            gallery.innerHTML = "<p>Aucune vid√©o publi√©e pour le moment.</p>";
            return;
        }

        snapshot.forEach((doc) => {
            const data = doc.data();
            gallery.innerHTML += `
                <div class="video-post" style="margin-bottom: 30px; background: #202020; padding: 15px; border-radius: 8px;">
                    <video controls src="${data.videoUrl}" style="width: 100%; max-height: 400px; border-radius: 4px;"></video>
                    <h3 style="margin: 10px 0 5px;">${data.title}</h3>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <img src="${data.channelAvatar}" alt="Avatar Cha√Æne" style="width: 24px; height: 24px; border-radius: 50%;">
                        <span style="color: #aaa; font-size: 13px;">${data.channelName}</span>
                    </div>
                    <p style="color: #ddd;">${data.description || ''}</p>
                </div>
            `;
        });
    }

    // D√©marrer la lecture au chargement
    // Note: loadVideos est appel√© dans onAuthStateChanged pour garantir l'affichage m√™me d√©connect√©
</script>
</body>
</html>
